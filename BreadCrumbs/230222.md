# Docker

## Dockerfile 작성하기

Dockerfile

```DOCKER
FROM node

WORKDIR /app

COPY . /app

RUN npm install

EXPOSE 80

CMD ["node", "server.js"]
```

<br>

```DOCKER
FROM node
```

- 일반적으로 `FROM` 명령으로 시작.
- 다른 베이스 이미지에 나의 이미지를 구축할 수 있음.
- 간단히 말하면, 도커에게 이렇게 말하는 것
  - '노드 이미지를 가지고 오는 것으로 시작할래.'

<br>

```DOCKER
COPY . /app
```

- 다음 단계로 도커에게 로컬 머신에 있는 파일이 이미지에 들어가야하는지를 알려야함.
- `COPY` 명령을 사용함
- 기본적으로 두 개의 경로를 지정하는데,
  - 첫 번째 경로는 컨테이너의 외부, 이미지의 외부 경로
  - 두 번째 경로는 이미지로 복사되어야 할 파일들이 있는 곳(컨테이너 또는 이미지 환경
- 첫 번째 환경에서 "."을 넣으면 기본적으로 Dockerfile이 포함된 동일한 폴더임을 알리는 것, 단 Dockerfile은 제외 됨.
  - 이 프로젝트의 모든 폴더, 하위 폴더 및 파일을 복사애햐 한다고 도커에게 알리는 것.
- 두 번째 "."은 그 파일을 저장해야하는 이미지 내부의 경로

  - 도커 컨테이너의 루트 엔트리를 사용하지 않고 전적으로 사용자가 선택한 서브 폴더를 사용하는 것이 좋음.

  <br>

```DOCKER
WORKDIR /app

RUN npm install
```

- node 애플리케이션의 모든 종속성을 설치하기 위해 npm install을 실행해야 함.
- 도커에서 이를 수행해주는 명령어 `RUN`
- 디폴트로 이러한 모든 명령은 도커 컨테이너 및 이미지의 작업 디렉토리에서 실행됨.
- 디폴트 작업 디렉토리는 컨테이너 파일 시스템의 루트 폴더임.

  - 여기서는 app 폴더에 복사하고 있기 때문에 npm install도 app 폴더 내에서 실행하고 싶음.

- 이때 사용하는 명령어가 `WORKDIR`
  - /app으로 설정하면 도커에게 모든 후속 명령이 그 폴더 내부에서 실행될 것임을 알리는 것.

<br>

```DOCKER
CMD ["node","server.js"]
```

- 마지막으로 모든 작업이 완료되면 서버를 시작하라는 명령어
- 하지만, `RUN node server.js`라고 할 수도 있지만, 이는 잘못되었음

  - 이 이미지가 빌드될 때마다 실행되기 때문.
  - 여기에 있는 모든 것은 이미지 설정을 위한 도커에 대한 명령.
  - 이미지는 컨테이너의 템플릿이어야함.
  - **그래서 이미지를 실행하는 것이 아니라, 이미지를 기반으로 컨테이너를 실행하는 것.**
  - 즉, 이미지를 기반으로 컨테이너를 시작하는 경우에만 서버를 시작하고 싶음.
    하나의 동일한 이미지에서 여러 컨테이너를 시작하면 노드 서버도 여러개가 됨.  
    따라서 컨테이너를 시작하는 경우에만 서버를 시작하고 싶음, 이때는 `CMD`를 사용

- `RUN`과 `CMD`의 차이점은, `CMD`는 이미지가 생성될 때 실행되지 않고 이미지를 기반으로 컨테이너가 시작될 때 실행된다는 점.
- CMD는 배열로 전달함.

<br>

```DOCKER
EXPORT 80

CMD ["node","server.js"]
```

- 노드 웹 서버는 포트 80에서 수신 대기하게 됨.
- 컨테이너 내부의 노드 애플리케이션에서 포트 80을 수신할 때 컨테이너는 그 포트를 우리의 로컬 머신에 노출하진 않음.
- 따라서 컨테이너 내부에서만 무언가를 수신 대기 중이기 때문에, 그 포트를 수신할 수 없음.
- 그래서 마지막 `CMD` 명령 전에 이 컨테이너가 시작 될 때, 우리의 로컬 시스템에서 특정 포트를 노출하고 싶다는 것을 도커에 알리는 EXPORT 80 명령을 추가해야 함.

<br>

## 컨테이너로 변환하기

```LINUX
docker build .
```

- Dockerfile을 기반으로 새 커스텀 이미지를 빌드하도록 도커에게 지시.
- 마지막 .은 경로표시, 명령을 실행하는 동일한 폴더에서 Dockerfile이 존재함을 알림.

<br>

```LINUX
docker run imageID
```

- 컨테이너가 시작되며 완료되지 않고 계속 실행되는 것을 볼 수 있는데, 그 이유는 노드 서버를 시작하기 때문

```DOCKER
CMD ["node", "server.js"]
```

<br>

- 하지만, localhost를 방문하면, Dockerfile에 포트를 노출했는데도 불구하고 표시되지 않음.

```LINUX
// 실행중인 목록 확인
docker ps

// 컨테이너 종료
docker stop containerID
```

- localhost에 표시되게 하기 위해선, 하나의 옵션을 추가해주어야함

```LINUX
docker run -p 3000:80 imageID
```

- 여기서 -p 플래스를 넣었음, 이는 publish를 나타냄
- 이를 통해 도커에서 어떤 로컬 포트가 있는지 알려줄 수 있음.
- 우리의 로컬 머신의 어떤 포트가 이 내부의 도커 특정 포트에서 액세스 할 수 있는지 알려줘야함.
- 즉, `엑세스하려는 로컬 포트:내부 도커 컨테이너 노출포트`를 넣어줄 것
- 이 경우엔 액세스하려는 로컬 포느는 3000, 내부 도커 컨테이너 노출포트는 위에서 작성한 80을 넣어줌.

<br>
